<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>权限管理</title>
    <link rel="stylesheet" href="../assets/libs/layui/css/layui.css"/>
    <link rel="stylesheet" href="../assets/module/admin.css?v=318"/>
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<!-- 正文开始 -->
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body">
            <!-- 表格工具栏 -->
            <form class="layui-form toolbar">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">权限名称:</label>
                        <div class="layui-input-inline">
                            <input name="authorityName" class="layui-input" placeholder="输入权限名称"/>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">菜单url:</label>
                        <div class="layui-input-inline">
                            <input name="menuUrl" class="layui-input" placeholder="输入路由地址"/>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">权限标识:</label>
                        <div class="layui-input-inline">
                            <input name="authority" class="layui-input" placeholder="输入权限标识"/>
                        </div>
                    </div>
                    <div class="layui-inline">&emsp;
                        <button class="layui-btn icon-btn" lay-filter="authoritiesTbSearch" lay-submit>
                            <i class="layui-icon">&#xe615;</i>搜索
                        </button>&nbsp;
                    </div>
                </div>
            </form>
            <!-- 数据表格 -->
            <table id="authoritiesTable"></table>
        </div>
    </div>
</div>

<!-- 表格操作列 -->
<script type="text/html" id="authoritiesTbBar">
    <a class="layui-btn layui-btn-checked layui-btn-xs" lay-event="edit">修改</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="add">添加</a>
</script>
<!-- 表单弹窗 -->
<script type="text/html" id="authoritiesEditDialog">
    <form id="authoritiesEditForm" lay-filter="authoritiesEditForm" class="layui-form model-form"
          style="padding-right: 20px;">
        <input name="authorityId" type="hidden"/>
        <div class="layui-row">
            <div class="layui-col-md6">
                <div class="layui-form-item">
                    <label class="layui-form-label">上级菜单</label>
                    <div class="layui-input-block">
                        <div id="authoritiesEditParentSel" class="ew-xmselect-tree"></div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label layui-form-required">权限名称:</label>
                    <div class="layui-input-block">
                        <input name="authorityName" placeholder="请输入权限名称" class="layui-input"
                               lay-verType="tips" lay-verify="required" required/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label layui-form-required">权限类型:</label>
                    <div class="layui-input-block">
                        <input name="isMenu" type="radio" value="0" title="菜单" checked/>
                        <input name="isMenu" type="radio" value="1" title="按钮"/>
                    </div>
                </div>

            </div>
            <div class="layui-col-md6">
                <div class="layui-form-item">
                    <label class="layui-form-label">权限标识:</label>
                    <div class="layui-input-block">
                        <input name="authority" placeholder="请输入权限标识" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">菜单url:</label>
                    <div class="layui-input-block">
                        <input name="menuUrl" placeholder="请输入菜单url" class="layui-input"/>
                    </div>
                </div>
                <!--                <div class="layui-form-item">-->
                <!--                    <label class="layui-form-label">菜单图标:</label>-->
                <!--                    <div class="layui-input-block">-->
                <!--                        <input name="menuIcon" placeholder="请输入菜单图标" class="layui-input"/>-->
                <!--                    </div>-->
                <!--                </div>-->
                <!--                <div class="layui-form-item">-->
                <!--                    <label class="layui-form-label layui-form-required">排序号:</label>-->
                <!--                    <div class="layui-input-block">-->
                <!--                        <input name="orderNumber" placeholder="请输入排序号" type="number" class="layui-input"-->
                <!--                               lay-verType="tips" lay-verify="required|number" required/>-->
                <!--                    </div>-->
                <!--                </div>-->
            </div>
        </div>
        <div class="layui-form-item text-right">
            <button class="layui-btn" lay-filter="authoritiesEditSubmit" lay-submit>保存</button>
            <button class="layui-btn layui-btn-primary" type="button" ew-event="closeDialog">取消</button>
        </div>
    </form>
</script>
<!-- js部分 -->
<script type="text/javascript" src="../assets/libs/layui/layui.js"></script>
<script type="text/javascript" src="../assets/js/common.js?v=318"></script>
<script>
    layui.use(['layer', 'form', 'admin', 'treeTable', 'util', 'xmSelect'], function () {
        var $ = layui.jquery;
        var layer = layui.layer;
        var form = layui.form;
        var admin = layui.admin;
        var treeTable = layui.treeTable;
        var util = layui.util;
        var xmSelect = layui.xmSelect;
        var tbDataList = [];

        // 渲染表格
        var insTb = treeTable.render({
            elem: '#authoritiesTable',
            // url: '/iframe/test.json',
            url: '/request/getMongoJson?name=user1',
            toolbar: ['<p>',
                '<button lay-event="add" class="layui-btn layui-btn-sm icon-btn"><i class="layui-icon">&#xe654;</i>添加</button>&nbsp;',
                '<button lay-event="del" class="layui-btn layui-btn-sm layui-btn-danger icon-btn"><i class="layui-icon">&#xe640;</i>删除</button>',
                '</p>'].join(''),
            tree: {
                iconIndex: 2,
                idName: 'authorityId',
                pidName: 'parentId',
                isPidData: true,
                arrowType: 'arrow2',
                getIcon: 'ew-tree-icon-style2'
            },
            cols: [[
                // {type: 'checkbox'},
                {type: 'numbers'},
                {
                    title: '类型', templet: function (d) {
                        return [
                            '<span class="layui-badge layui-badge-green">菜单</span>',
                            '<span class="layui-badge layui-badge-gray">文件</span>'
                        ][d.isMenu];
                    }, align: 'center', width: 80
                },
                {field: 'authorityName', title: '文件名称<i class=\"layui-icon\">&#xe642;</i>', minWidth: 150,edit:'text'},
                {field: 'menuUrl', title: '菜单url'},
                {field: 'authority', title: '权限标识'},
                // {field: 'orderNumber', title: '排序号', align: 'center', width: 80},

                {title: '创建时间', templet: '<p>{{layui.util.toDateString(d.createTime)}}</p>', align: 'center'},
                {title: '操作', toolbar: '#authoritiesTbBar', align: 'center', width: 190}
            ]],
            done: function (data) {
                tbDataList = data;
            }
        });

        /* 表格操作列点击事件 */
        treeTable.on('tool(authoritiesTable)', function (obj) {
            if (obj.event === 'edit') { // 修改
                showEditModel(obj);
            } else if (obj.event === 'del') { // 删除
                doDel(obj);
            } else if(obj.event === 'add') {
                doAdd(obj);
            }
        });

        /* 表格头工具栏点击事件 */
        treeTable.on('toolbar(authoritiesTable)', function (obj) {
            if (obj.event === 'add') { // 添加
                showEditModel();
            } else if (obj.event === 'del') { // 删除
                var checkRows = insTb.checkStatus();
                if (checkRows.length === 0) {
                    layer.msg('请选择要删除的数据', {icon: 2});
                    return;
                }
                var ids = checkRows.map(function (d) {
                    return d.authorityId;
                });
                doDel({ids: ids});
            }
        });

        /* 表格搜索 */
        form.on('submit(authoritiesTbSearch)', function (data) {
            doTbSearch(data.field, 'authorityId');
            return false;
        });

        /* 添加 */
        $('#authoritiesAddBtn').click(function () {
            showEditModel();
        });

        /* 显示表单弹窗 */
        function showEditModel(obj) {
            // mData = obj.data
            // admin.open({
            //     type: 1,
            //     area: '600px',
            //     title: (mData ? '修改' : '添加') + '权限',
            //     content: $('#authoritiesEditDialog').html(),
            //     success: function (layero, dIndex) {
            //         // 回显表单数据
            //         form.val('authoritiesEditForm', mData);
            //         // 表单提交事件
            //         form.on('submit(authoritiesEditSubmit)', function (data) {
            //             data.field.parentId = insXmSel.getValue('valueStr');
            //             var loadIndex = layer.load(2);
            //             $.get(mData ? 'iframe/json/ok.json' : 'iframe/json/ok.json', data.field, function (res) {
            //                 layer.close(loadIndex);
            //                 console.log(data)
            //                 if (res.code === 200) {
            //                     layer.close(dIndex);
            //                     layer.msg(res.msg, {icon: 1});
            //                     insTb.refresh();
            //                 } else {
            //                     layer.msg(res.msg, {icon: 2});
            //                 }
            //             }, 'json');
            //             return false;
            //         });
            //         // 渲染下拉树
            //         var insXmSel = xmSelect.render({
            //             el: '#authoritiesEditParentSel',
            //             height: '250px',
            //             data: insTb.options.data,
            //             initValue: mData ? [mData.parentId] : [],
            //             model: {label: {type: 'text'}},
            //             prop: {
            //                 name: 'authorityName',
            //                 value: 'authorityId'
            //             },
            //             radio: true,
            //             clickClose: true,
            //             tree: {
            //                 show: true,
            //                 indent: 15,
            //                 strict: false,
            //                 expandedKeys: true
            //             }
            //         });
            //         // 弹窗不出现滚动条
            //         $(layero).children('.layui-layer-content').css('overflow', 'visible');
            //     }
            // });
            var tree = $.extend(true, {}, insTb.options.data[0])             //tt.options.data中存放着整个树
            var updateNode = obj.data.authorityId              //delNode记录待删除的节点号
            let node = []
            let res = []
            node.push(tree)
            while(node.length != 0) {                        //使用一个队列实现遍历整棵树
                var temp = node.shift()
                if(temp.authorityId == updateNode){
                    // console.log(temp)
                    // console.log(obj.data)
                    // temp = obj.data;

                }
                // console.log(temp)
                res.push(temp)
                if(temp.children != undefined)                  //继续向后遍历
                    for(var i = temp.children.length - 1; i >= 0; i--){
                        node.unshift(temp.children[i])
                    }
            }
            for(var i = 0; i < res.length;i ++){
                delete res[i].children
                delete res[i].LAY_INDEX
                delete res[i].open
                res[i]['open'] = true
                res[i] = JSON.stringify(res[i])
            }
            // console.log(res)
            $.ajax({
                url:'request/changeMongoJson',
                type:'POST',
                async: false,
                traditional: true,
                data:{"res": res, "name": "user1"},
                success:function(response){
                    layer.msg("更新成功", {icon: 1});
                    insTb.refresh();
                },
                error:function () {
                    layer.msg("更新失败", {icon: 2});
                    insTb.refresh();
                }
            })
        }

        /* 删除 */
        function doDel(obj) {
            layer.confirm('确定要删除选中数据吗？', {
                skin: 'layui-layer-admin',
                shade: .1
            }, function (i) {
                layer.close(i);
                var loadIndex = layer.load(2);
                // var optiondata = $.extend(true, {}, insTb.options.data)
                var tree = insTb.options.data[0]              //insTb.options.data中存放着整个树
                var delNode = obj.data.authorityId              //delNode记录待删除的节点号
                var delParent
                var delLength = 1                               //记录一共删除的节点个数
                var mark = false
                // console.log(tree)
                let node = []
                let res = []
                node.push(tree)
                while(node.length != 0){                        //使用一个队列实现遍历整棵树
                    var temp = node.shift()
                    if(node.length != 0)
                        var temp2 = node[0]
                    else
                        var temp2 = temp
                    if(temp.authorityId != delNode) {
                        if (mark) {
                            temp.authorityId -= delLength
                            temp.orderNumber -= delLength
                            if (temp.parentId > delParent)
                                temp.parentId -= delLength
                        }
                        res.push(temp)
                    }
                    if(temp.authorityId == delNode && !mark) {           //如果当前节点是待删除根节点，判断其是否为目录，删除其所有子节点并将其标记为-2
                        // console.log(delNode)
                        if (temp.isMenu == 0) {                  //并计算出删除的总结点数
                            delLength += (temp2.authorityId - temp.authorityId - 1);    //删除的节点数就是它自己加上它的子节点(下一个同级目录与它的序号差值)
                            temp.authorityId = -2
                            delete temp.children
                        } else {
                            temp.authorityId = -2
                        }
                        mark = true
                        delParent = temp.parentId
                    }
                    if(temp.children != undefined)                  //继续向后遍历
                        for(var i = temp.children.length - 1; i >= 0; i--){
                            node.unshift(temp.children[i])
                        }
                }
                // console.log(tree)
                // console.log(delLength)
                // console.log(res)
                for(var i = 0; i < res.length;i ++){
                    delete res[i].children
                    delete res[i].LAY_INDEX
                    delete res[i].open
                    res[i]['open'] = true
                    res[i] = JSON.stringify(res[i])
                }
                console.log(res)
                $.ajax({
                    url:'request/changeMongoJson',
                    type:'POST',
                    async: false,
                    traditional: true,
                    data:{"res": res, "name": "user1"},
                    success:function(response){
                        //请求成功后执行的代码
                        // insTb.options.data = optiondata
                        // obj.del()
                        layer.close(loadIndex);
                        layer.msg("删除成功", {icon: 1});
                        insTb.refresh();
                    },
                    error:function(status){
                        //失败后执行的代码
                        // alert("fail")
                        layer.close(loadIndex);
                        layer.msg("无法删除根目录", {icon: 2});
                        insTb.refresh();
                    }
                })

            });
        }

        function doAdd(obj){
            mData = obj.data
            if(obj.data.isMenu == 0)
                admin.open({
                    type: 1,
                    area: '600px',
                    title: '新建文件',
                    content: $('#authoritiesEditDialog').html(),
                    success: function (layero, dIndex) {
                        // 回显表单数据
                        form.val('authoritiesEditForm', mData);
                        // 表单提交事件
                        form.on('submit(authoritiesEditSubmit)', function (data) {
                            data.field.parentId = insXmSel.getValue('valueStr');
                            var newNode = new Object();
                            newNode["authorityId"] = parseInt(data.field.authorityId) + 1
                            newNode["orderNumber"] = parseInt(data.field.authorityId) + 1
                            newNode["authorityName"] = data.field.authorityName
                            newNode["authority"] = data.field.authority
                            newNode["isMenu"] = parseInt(data.field.isMenu)
                            newNode["menuUrl"] = data.field.menuUrl
                            newNode["parentId"] = parseInt(data.field.parentId)
                            newNode["menuIcon"] = null
                            Date.prototype.Format = function (fmt) { // author: meizz
                                var o = {
                                    "M+": this.getMonth() + 1, // 月份
                                    "d+": this.getDate(), // 日
                                    "h+": this.getHours(), // 小时
                                    "m+": this.getMinutes(), // 分
                                    "s+": this.getSeconds(), // 秒
                                    "q+": Math.floor((this.getMonth() + 3) / 3), // 季度
                                    "S": this.getMilliseconds() // 毫秒
                                };
                                if (/(y+)/.test(fmt))
                                    fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
                                for (var k in o)
                                    if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                                return fmt;
                            }
                            newNode["createTime"] = new Date().Format("yyyy-MM-dd hh:mm:ss")
                            newNode["updateTime"] = new Date().Format("yyyy-MM-dd hh:mm:ss")
                            newNode["open"] = true
                            // console.log(newNode)
                            var tree = insTb.options.data[0]            //tt.options.data中存放着整个树
                            var addNode = newNode.authorityId              //delNode记录待删除的节点号
                            let node = []
                            let res = []
                            node.push(tree)
                            while(node.length != 0) {                        //使用一个队列实现遍历整棵树
                                var temp = node.shift()
                                // console.log(temp)
                                var tempcopy = new Object()
                                if(temp.authorityId == addNode || temp == tree) {
                                    res.push(newNode)
                                }
                                if(temp.authorityId >= addNode) {
                                    tempcopy["authorityId"] = temp.authorityId + 1
                                    tempcopy["orderNumber"] = temp.authorityId + 1
                                } else {
                                    tempcopy["authorityId"] = temp.authorityId
                                    tempcopy["orderNumber"] = temp.authorityId
                                }
                                tempcopy["authorityName"] =temp.authorityName
                                tempcopy["authority"] = temp.authority
                                tempcopy["isMenu"] = temp.isMenu
                                tempcopy["menuUrl"] = temp.menuUrl
                                if(temp.parentId >= addNode) tempcopy["parentId"] = temp.parentId + 1
                                else tempcopy["parentId"] = temp.parentId
                                tempcopy["menuIcon"] = null
                                tempcopy["createTime"] = temp.createTime
                                tempcopy["updateTime"] = temp.updateTime
                                tempcopy["open"] = true
                                res.push(tempcopy)
                                // console.log(temp)
                                if(temp.children != undefined)                  //继续向后遍历
                                    for(var i = temp.children.length - 1; i >= 0; i--){
                                        node.unshift(temp.children[i])
                                    }
                            }
                            //  console.log(tree)
                            // console.log(res)
                            for(var i = 0; i < res.length;i ++){
                                res[i] = JSON.stringify(res[i])
                            }
                            console.log(res)
                            $.ajax({
                                url:'request/changeMongoJson',
                                type:'POST',
                                async: false,
                                traditional: true,
                                data:{"res": res, "name": "user1"},
                                success:function(response){
                                    //请求成功后执行的代码
                                },
                                error:function(status){
                                    //失败后执行的代码
                                    // alert("fail")
                                }
                            })


                            var loadIndex = layer.load(2);
                            $.get(mData ? 'iframe/json/ok.json' : 'iframe/json/ok.json', data.field, function (res) {
                                layer.close(loadIndex);
                                // console.log(data)
                                if (res.code === 200) {
                                    layer.close(dIndex);
                                    layer.msg(res.msg, {icon: 1});
                                    insTb.refresh();
                                } else {
                                    layer.msg(res.msg, {icon: 2});
                                }
                            }, 'json');
                            return false;
                        });
                        // 渲染下拉树
                        var insXmSel = xmSelect.render({
                            el: '#authoritiesEditParentSel',
                            height: '0px',
                            data: insTb.options.data,
                            initValue: mData ? [mData.authorityId] : [],
                            model: {label: {type: 'text'}},
                            prop: {
                                name: 'authorityName',
                                value: 'authorityId'
                            },
                            radio: true,
                            clickClose: true,
                            tree: {
                                show: true,
                                indent: 15,
                                strict: false,
                                expandedKeys: true
                            }
                        });
                        // 弹窗不出现滚动条
                        $(layero).children('.layui-layer-content').css('overflow', 'visible');
                    }
                });
            else
                layer.msg("这不是一个菜单", {icon: 2});

        }
        /* 搜索表格数据 */
        function doTbSearch(field, idName) {
            var ids = [], isClear = true;
            for (var i = 0; i < tbDataList.length; i++) {
                var item = tbDataList[i], flag = true;
                for (var f in field) {
                    if (!field.hasOwnProperty(f)) continue;
                    if (!field[f]) continue;
                    isClear = false;
                    if (!item[f] || item[f].indexOf(field[f]) === -1) {
                        flag = false;
                        break;
                    }
                }
                if (flag) ids.push(item[idName]);
            }
            if (isClear) {
                insTb.clearFilter();
            } else {
                insTb.filterData(ids);
            }
        }

    });
</script>
</body>
</html>