<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>用户管理</title>
    <link rel="stylesheet" href="../iframe/assets/libs/layui/css/layui.css"/>
    <link rel="stylesheet" href="../iframe/assets/module/admin.css?v=318"/>
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<!-- 正文开始 -->
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body">
            <!-- 表格工具栏 -->
            <form id="unitFindForm" lay-filter="unitFindForm" class="layui-form toolbar">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">单位名称:</label>
                        <div class="layui-input-inline">
                            <input name="dwmc" class="layui-input" placeholder="输入名称"/>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">单位代码:</label>
                        <div class="layui-input-inline">
                            <input name="dwdm" class="layui-input" placeholder="输入代码"/>
                        </div>
                    </div>
                    <div class="layui-inline">&emsp;
                        <button class="layui-btn icon-btn" lay-filter="unitTbSearch" lay-submit>
                            <i class="layui-icon">&#xe615;</i>搜索
                        </button>
                    </div>
                </div>
            </form>
            <!-- 数据表格 -->
            <table id="unitTable" lay-filter="unitTable" class="layui-table"></table>
        </div>
    </div>
</div>

<!-- 表格操作列 -->
<script type="text/html" id="unitTbBar">
    <a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="edit">修改</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>
<!-- 表格状态列 -->
<script type="text/html" id="userTbState">
    <input type="checkbox" lay-filter="userTbStateCk" value="{{d.userId}}" lay-skin="switch"
           lay-text="正常|锁定" {{d.state==0?'checked':''}} style="display: none;"/>
    <p style="display: none;">{{d.state==0?'正常':'锁定'}}</p>
</script>
<!-- 表单弹窗 -->
<script type="text/html" id="unitEditDialog" style="width: 600px">
    <form id="unitEditForm" lay-filter="unitEditForm" class="layui-form model-form" style="padding-right: 20px;">
        <!--        <input name="userId" type="hidden"/>-->
        <div class="layui-row">
            <div class="layui-col-md6">
                <div class="layui-form-item">
                    <label class="layui-form-label layui-form-required">单位代码:</label>
                    <div class="layui-input-block">
                        <input name="dwdm" placeholder="请输入单位代码" class="layui-input"
                               lay-verType="tips" lay-verify="required" required/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label layui-form-required">单位名称:</label>
                    <div class="layui-input-block">
                        <input name="dwmc" placeholder="请输入单位名称" class="layui-input"
                               lay-verType="tips" lay-verify="required" required/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">单位类型</label>
                    <div class="layui-input-block">
                        <div id="dwxzmc"></div>
                    </div>
                </div>
                <div class="layui-form-item" id="area-picker">
                    <div class="layui-form-label">单位地址:</div>
                    <div class="layui-input-inline" style="width: 80px;">
                        <select  name="dwszsf" class="province-selector" data-value="" lay-filter="province-1">
                            <option value="">选择省</option>
                        </select>
                    </div>
                    <div class="layui-input-inline" style="width: 80px;">
                        <select name="dwszcs" class="city-selector" data-value="" lay-filter="city-1">
                            <option value="">选择市</option>
                        </select>
                    </div>
                    <div class="layui-input-inline" style="width: 80px;">
                        <select name="dwszqx" class="county-selector" data-value="" lay-filter="county-1">
                            <option value="">选择区</option>
                        </select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label layui-form-required">具体地址:</label>
                    <div class="layui-input-block">
                        <input name="dwszdz" placeholder="请输入具体地址" class="layui-input"
                               lay-verType="tips" lay-verify="required" required/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label layui-form-required">单位邮编:</label>
                    <div class="layui-input-block">
                        <input name="dwyzbm" placeholder="请输入单位邮编" class="layui-input"
                               lay-verType="tips" lay-verify="required" required/>
                    </div>
                </div>
            </div>
            <div class="layui-col-md6">
                <div class="layui-form-item">
                    <label class="layui-form-label layui-form-required">单位法人:</label>
                    <div class="layui-input-block">
                        <input name="dwfr" placeholder="请输入单位法人" class="layui-input"
                               lay-verType="tips" lay-verify="required" required/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label layui-form-required">联系人:</label>
                    <div class="layui-input-block">
                        <input name="dwlxr" placeholder="请输入联系人" class="layui-input"
                               lay-verType="tips" lay-verify="required" required/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label layui-form-required">移动电话:</label>
                    <div class="layui-input-block">
                        <input name="lxryddh" placeholder="请输入移动电话" class="layui-input"
                               lay-verType="tips" lay-verify="required" required/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label layui-form-required">固定电话:</label>
                    <div class="layui-input-block">
                        <input name="lxrgddh" placeholder="请输入固定电话" class="layui-input"
                               lay-verType="tips" lay-verify="required" required/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label layui-form-required">邮箱:</label>
                    <div class="layui-input-block">
                        <input name="lxrmail" placeholder="请输入邮箱" class="layui-input"
                               lay-verType="tips" lay-verify="required" required/>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-form-item text-right">
            <button class="layui-btn" lay-filter="unitEditSubmit" lay-submit>保存</button>
            <button class="layui-btn layui-btn-primary" type="button" ew-event="closeDialog">取消</button>
        </div>
    </form>
</script>

<!-- js部分 -->
<script type="text/javascript" src="../iframe/assets/libs/layui/layui.js"></script>
<script type="text/javascript" src="../iframe/assets/js/common.js?v=318"></script>
<script>
    layui.use(['layer', 'form', 'table', 'util', 'admin', 'xmSelect', 'layarea'], function () {
        var $ = layui.jquery;
        var layer = layui.layer;
        var form = layui.form;
        var table = layui.table;
        var util = layui.util;
        var admin = layui.admin;
        var xmSelect = layui.xmSelect;
        var layarea = layui.layarea;
        /* 渲染表格 */
        var insTb = table.render({
            elem: '#unitTable',
            // url: '/iframe/json/user1.json',
            url: '/unit_request/getAllUnit',
            id: 'testReload',
            page: true,
            // even: true,
            toolbar: ['<p>',
                '<button lay-event="add" class="layui-btn layui-btn-sm icon-btn"><i class="layui-icon">&#xe654;</i>添加</button>&nbsp;',
                '</p>'].join(''),
            cellMinWidth: 100,
            cols: [
                [
                    {type: 'numbers'},
                    {field: 'dwmc', title: '单位名称'},
                    {field: 'dwdm', title: '单位代码', sort: true},
                    {field: 'dwxzmc', title: '单位类型'},
                    {field: 'dwszdz', title: '单位地址'},
                    {field: 'dwlxr', title: '联系人'},
                    {field: 'lxryddh', title: '联系方式'},
                    {title: '操作', toolbar: '#unitTbBar', align: 'center', minWidth: 200}
                ]
            ],
            where: {data:{dwmc: "理工大"}}
        });

        /* 表格搜索 */
        form.on('submit(unitTbSearch)', function (data) {
            var mark = 0
            if(data.field.dwdm ==  '' && data.field.dwmc == ''){
                insTb.reload({url: '/unit_request/getAllUnit'});
                layer.msg('查询成功', {icon: 1});
            } else {
                // insTb.reload({
                //     url: '/unit_request/findUnit?param1=' + data.field.dwmc + '&param2=' + data.field.dwdm,
                //     parseData: function (res) {       //自定义解析返回的数据,本来是用来做返回数据处理的
                //         console.log(res)
                //         mark = 1
                //         if (res.msg == 'find')
                //             layer.msg('查询成功', {icon: 1});
                // }
                // })
                // if (mark == 0)
                //     layer.msg('查询失败', {icon: 2});
            }
            /*
            *   这里做如下说明
            * 1. 使用/unit_request/getAllUnit进行没有输入时的查询，使用/unit_request/findUnit接参数的方式进行有参数时的查询
            * 2. 使用parseData区分查询成功与失败，成功时会走parseData（本来是做返回数据格式处理的），失败则因为mark==0，弹出’查询失败‘
            * 3. 我这里修改了table.js源码（E:\IdeaProjects\workproject\src\main\resources\static\iframe\assets\libs\layui\lay\modules\table.js）
            *    （1）修改了error（203行）的打印内容
            *    （2）修改为async:false
            * */
            return false
        });

        /* 表格工具条点击事件 */
        table.on('tool(unitTable)', function (obj) {
            if (obj.event === 'edit') { // 修改
                showEditModel(obj.data);
            } else if (obj.event === 'del') { // 删除
                doDel(obj);
            } else if (obj.event === 'reset') { // 重置密码
                resetPsw(obj);
            }
        });

        /* 表格头工具栏点击事件 */
        table.on('toolbar(unitTable)', function (obj) {
            if (obj.event === 'add') { // 添加
                showEditModel();
            } else if (obj.event === 'del') { // 删除
                var checkRows = table.checkStatus('unitTable');
                if (checkRows.data.length === 0) {
                    layer.msg('请选择要删除的数据', {icon: 2});
                    return;
                }
                var ids = checkRows.data.map(function (d) {
                    return d.userId;
                });
                doDel({ids: ids});
            }
        });

        /* 显示表单弹窗 */
        function showEditModel(mData) {
            admin.open({
                type: 1,
                title: (mData ? '修改' : '添加') + '单位信息',
                content: $('#unitEditDialog').html(),
                area: '780px',
                success: function (layero, dIndex) {
                    // 回显表单数据
                    layarea.render({
                        elem: '#area-picker',
                        temp: 'list',
                        data: {
                            province: mData ? mData.dwszsf:'',
                            city: mData? mData.dwszcs:'',
                            county: mData? mData.dwszqx:''
                        },
                        change: function (res) {
                            //选择结果
                            // console.log(res);
                        }
                    });
                    form.val('unitEditForm', mData);
                    // 表单提交事件
                    form.on('submit(unitEditSubmit)', function (data) {
                        var param = new Array(13)
                        var i = 0
                        for(let key in data.field) {
                            param[i++] = data.field[key]
                        }
                        var loadIndex = layer.load(2);
                        if(mData) {
                            $.ajax({
                                url: '/unit_request/updateUnit',
                                type: 'POST',
                                async: false,
                                traditional: true,
                                data: {'param': param},
                                success: function (response) {
                                    layer.close(dIndex);
                                    layer.close(loadIndex)
                                    layer.msg("修改成功", {icon: 1});
                                    insTb.reload({page: {curr: insTb.config.page.curr}});
                                }
                            })
                        } else {
                            $.ajax({
                                url: '/unit_request/insertUnit',
                                type: 'POST',
                                async: false,
                                traditional: true,
                                data: {'param': param},
                                success: function (response) {
                                    layer.close(dIndex);
                                    layer.close(loadIndex)
                                    layer.msg("添加成功", {icon: 1});
                                    insTb.reload({page: {curr: insTb.config.page.curr}});
                                }
                            })
                        }
                        return false;
                    });
                    // 渲染多选下拉框
                    var insRoleSel = xmSelect.render({
                        el: '#dwxzmc',
                        name: 'dwxzmc',
                        layVerify: 'required',
                        layVerType: 'tips',
                        data: [{
                            name: '外资独企',
                            value: 10
                        }, {
                            name: '民营企业',
                            value: 11
                        }, {
                            name: '国有企业',
                            value: 12
                        }, {
                            name: '政府机关',
                            value: 13
                        }, {
                            name: '事业单位',
                            value: 14
                        }, {
                            name: '非盈利组织',
                            value: 15
                        }, {
                            name: '国防军事',
                            value: 16
                        }, {
                            name: '宗教团体',
                            value: 17
                        }]
                    });
                    // 回显选中角色
                    if (mData && mData.dwxzid) {
                        insRoleSel.setValue([mData.dwxzid]);
                    }
                    // 禁止弹窗出现滚动条
                    $(layero).children('.layui-layer-content').css('overflow', 'visible');
                }
            });
        }

        /* 删除 */
        function doDel(obj) {
            // obj.del()
            // console.log(insTb.config.page.curr)
            layer.confirm('确定要删除选中单位吗？', {
                skin: 'layui-layer-admin',
                shade: .1
            }, function (i) {
                layer.close(i);
                var loadIndex = layer.load(2);
                // console.log(obj)
                $.ajax({
                    url:'/unit_request/deleteUnit',
                    type:'POST',
                    async: false,
                    // traditional: true,
                    data:{"ID": obj.data.dwdm},
                    success:function(response) {
                        layer.close(loadIndex)
                        layer.msg("删除成功", {icon: 1});
                        insTb.reload({page: {curr: insTb.config.page.curr}});
                    }
                })
            });
        }
    });
</script>
</body>
</html>
